# This is the build pipeline. Pipelines are the core of wercker
# Read more about pipelines on our dev center
# https://devcenter.wercker.com/development/pipelines/
box:
  id: alpine
build:
  steps:
  - script:
      name: noop
      code: |
        echo 'todo build script here'
test-jvm:
  box: openjdk:8-jdk
  service:
  - "mysql:5.7"
    env:
      MYSQL_ROOT_PASSWORD: rootpw
      MYSQL_DATABASE: test_db
  # https://devcenter.wercker.com/administration/services/service-container-networking/#getting-the-environment-variables
  # https://devcenter.wercker.com/administration/services/examples/mysql/
  steps:
  - script:
      name: expand env
      code: env
  - script:
      name: mapping env
      code: |
        export CARBON_TEST_RDB_HOST=${MYSQL_PORT_3306_TCP_ADDR}
        export CARBON_TEST_RDB_PORT=${MYSQL_PORT_3306_TCP_PORT}
        export CARBON_TEST_RDB_SCHEMA=test_db
        export CARBON_TEST_RDB_USER=root
        export CARBON_TEST_RDB_PASSWORD=rootpw

  # https://github.com/wercker/step-gradle
  - java/gradle:
    task: clean test
    cache_project_cache: true

test-node:
  box: node:10.9.0-alpine
  steps:
  - script:
      name: add git
      code: |
        apk update && \
        apk upgrade && \
        apk add --no-cache git
  - script:
    name: install
    code:  |
      cd carbon-crawler-admin-front
      yarn install
  - script:
    name: test
    code: |
      cd carbon-crawler-admin-front
      yarn test

build-jvm:
  box: openjdk:8-jdk
  steps:
  - java/gradle:
    task: clean build -x test
    cache_project_cache: true

build-docker:
  steps:
  - internal/docker-build:
    dockerfile: carbon-crawler-ci/carbon_jre/Dockerfile
    image-name: carbon-crawler-admin-api
    build-args: "JAR_FILE=carbon-crawler-admin-api/build/libs/carbon-crawler-admin-api-LATEST.jar"
  - internal/docker-build:
    dockerfile: carbon-crawler-ci/carbon_jre/Dockerfile
    image-name: carbon-crawler-stream-flow-crawl-listing-sink
    build-args: "JAR_FILE=carbon-crawler-stream/flow/crawl-listing-sink/build/libs/crawl-listing-sink-LATEST.jar"
  - internal/docker-build:
    dockerfile: carbon-crawler-ci/carbon_jre/Dockerfile
    image-name: carbon-crawler-stream-flow-crawl-listing-source
    build-args: "JAR_FILE=carbon-crawler-stream/flow/crawl-listing-sink/build/libs/crawl-listing-source-LATEST.jar"
